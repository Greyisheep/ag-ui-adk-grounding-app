# ADK + AG-UI + CopilotKit Setup Guide

This guide documents the complete process of setting up a full-stack AI agent application using Google's Agent Development Kit (ADK), AG-UI Protocol, and CopilotKit, following the [official tutorial](https://dev.to/copilotkit/build-a-frontend-for-your-adk-agents-with-ag-ui-2alo).

## Overview

We built a complete AI agent application with:
- **Backend**: ADK agent with AG-UI protocol integration
- **Frontend**: Next.js app with CopilotKit for real-time agent interaction
- **Communication**: AG-UI protocol bridges frontend and backend

## Prerequisites

- Node.js 18+
- Python 3.12+
- Google Makersuite API Key
- Package manager (npm, pnpm, yarn, or bun)

## Step-by-Step Setup

### 1. Initialize Project

```bash
# Create new ADK + AG-UI + CopilotKit project
npx copilotkit@latest create ag-ui-adk-app -f adk -q
```

This command:
- Creates a new Next.js project with ADK template
- Sets up both frontend (Next.js) and backend (Python ADK agent)
- Configures AG-UI protocol integration
- Includes CopilotKit for frontend agent interaction

### 2. Install Dependencies

```bash
cd ag-ui-adk-app

# Install Node.js dependencies (includes Python agent setup)
npm install
```

The `npm install` command automatically:
- Installs Node.js packages
- Runs the agent setup script (`./scripts/setup-agent.sh`)
- Creates Python virtual environment in `agent/` directory
- Installs Python dependencies from `agent/requirements.txt`

### 3. Configure API Keys

Create `.env` file in the project root:

```bash
# .env
GOOGLE_API_KEY="your-google-api-key-here"
```

**Note**: Get your Google API key from [Google Makersuite](https://makersuite.google.com/app/apikey)

### 4. Add CopilotKit Public Key

Update `src/app/layout.tsx` to include the CopilotKit public API key:

```tsx
<CopilotKit
  runtimeUrl="/api/copilotkit"
  agent="my_agent"
  publicApiKey="ck_pub_d32f50c4facc8b852513e180745487c3"
>
  {children}
</CopilotKit>
```

### 5. Start Development Servers

```bash
npm run dev
```

This command starts both servers concurrently:
- **UI Server**: Next.js on `http://localhost:3000`
- **Agent Server**: ADK agent on `http://localhost:8000`

## Project Structure

```
ag-ui-adk-app/
├── agent/                    # ADK agent backend
│   ├── agent.py             # Main agent logic
│   ├── requirements.txt      # Python dependencies
│   └── .venv/               # Python virtual environment
├── src/
│   └── app/
│       ├── layout.tsx       # CopilotKit provider setup
│       ├── page.tsx         # Main UI with agent integration
│       └── api/
│           └── copilotkit/
│               └── route.ts # CopilotKit API route
├── scripts/                 # Setup and run scripts
├── package.json            # Node.js dependencies
└── .env                    # Environment variables
```

## Key Features Implemented

### Frontend Actions
- **Theme Color**: Agent can change the app's theme color
- **Proverbs Management**: Add/remove proverbs through agent interaction

### Shared State
- **Agent State**: Real-time state synchronization between frontend and backend
- **Proverbs Array**: Persistent list managed by the agent

### Generative UI
- **Weather Cards**: Dynamic UI components generated by agent tool calls
- **Real-time Updates**: UI updates automatically based on agent actions

### Grounding Capabilities
- **Google Search Grounding**: Real-time web search via a dedicated research agent that wraps the built-in `google_search` tool
- **Google Maps Grounding**: Place and location lookups handled by a separate maps agent that wraps the `google_maps` tool
- **Agent-as-Tool Wrappers**: Main agent delegates to these grounded agents using ADK `Runner` instances, avoiding tool conflicts

## Agent Capabilities

The ADK agent includes several built-in tools:

1. **setThemeColor**: Changes the application theme
2. **get_weather**: Generates weather information cards
3. **Proverbs Management**: Adds/removes proverbs from the shared state
4. **research_current_information**: Delegates to a Google Search grounded agent (Gemini 2.5 + `google_search`)
5. **find_places_information**: Delegates to a Google Maps grounded agent (Gemini 2.5 + `google_maps`)

## Testing the Application

1. Open `http://localhost:3000` in your browser
2. The CopilotKit sidebar should be open by default
3. Try these example prompts:
   - "Set the theme to orange"
   - "Write a proverb about AI"
   - "Get the weather in San Francisco"
   - "Add a new proverb about technology"
   - "What's the latest news about artificial intelligence?"
   - "Find coffee shops near me"
   - "Search for information about climate change"
   - "What restaurants are near Central Park?"

## Troubleshooting

### Agent Connection Issues
If you see "I'm having trouble connecting to my tools":
1. Verify the ADK agent is running on port 8000
2. Check that your Google API key is set correctly
3. Ensure both servers started successfully

### Python Dependencies
If you encounter Python import errors:
```bash
cd agent
pip install -r requirements.txt
```

### Linting Issues
```bash
npm run lint
```

## Available Scripts

- `npm run dev` - Start both UI and agent servers
- `npm run dev:ui` - Start only the Next.js UI server
- `npm run dev:agent` - Start only the ADK agent server
- `npm run build` - Build for production
- `npm run lint` - Run ESLint

## Grounding Implementation

The agent uses the **Agent-as-Tool Pattern** backed by ADK `Runner` instances for Google Search and Google Maps grounding. This mirrors the approach used in the official ADK tools ([Google Search Tool](https://github.com/google/adk-python/blob/main/src/google/adk/tools/google_search_tool.py), [Google Maps Grounding Tool](https://github.com/google/adk-python/blob/main/src/google/adk/tools/google_maps_grounding_tool.py)) and community examples.

### Key Design Decisions

1. **Dedicated Grounded Agents**: `SearchResearchAgent` and `MapsResearchAgent` each own a single built-in tool to avoid the "function search is not found" limitation in mixed-tool agents.
2. **Runner-backed Execution**: Wrapper tools instantiate a lightweight ADK `Runner` with in-memory session services to execute the specialist agent inside the official invocation pipeline.
3. **Context Reuse**: The wrapper reuses the calling agent's invocation context (user ID, session ID, event actions) so credentials and state remain consistent.
4. **Structured Payloads**: Wrapper tools return normalized dicts (`status`, `message`, `data.response_text`, etc.) that the main agent can summarise for the user.

### Implementation Details

```python
class SearchResearchAgent(BaseGroundedAgent):
    def __init__(self):
        super().__init__(
            name="SearchResearchAgent",
            instruction="Use Google Search grounding to gather current, factual information.",
            tools=[GoogleSearchTool()],
        )

def research_current_information(tool_context: ToolContext, query: str) -> dict:
    inner_ctx = ToolContext(
        tool_context._invocation_context,
        function_call_id=tool_context.function_call_id,
        event_actions=tool_context.actions,
        tool_confirmation=tool_context.tool_confirmation,
    )
    result = _run_grounded_agent(
        SearchResearchAgent(),
        query=query,
        tool_context=inner_ctx,
        runner_app_name="search_grounding_app",
        runner_session_service=search_session_service,
        logger_prefix="🔍 RESEARCH_TOOL",
    )
    return result
```

### Benefits

- ✅ **ADK-compliant Grounding**: Uses the built-in Gemini 2 tooling as designed, ensuring reliability and future compatibility.
- ✅ **Isolation of Concerns**: Main agent focuses on UI/state tasks while dedicated agents handle external data retrieval.
- ✅ **Session-aware**: Wrapper passes through the invocation context so authentication, state, and memory are preserved.
- ✅ **Observable**: Detailed logging captures every grounding request/result for debugging.

## Architecture

```
┌─────────────────┐    AG-UI Protocol    ┌─────────────────┐
│   Next.js UI    │◄──────────────────►│   ADK Agent      │
│   (CopilotKit)  │                    │   (Python)       │
└─────────────────┘                    └─────────────────┘
         │                                      │
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│   Frontend      │                    │   Gemini API    │
│   Actions       │                    │   Integration   │
└─────────────────┘                    └─────────────────┘
         │                                      │
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│   Agent Tools   │                    │   Grounded      │
│   (Functions)   │                    │   Runner Agents │
└─────────────────┘                    └─────────────────┘
         │                                      │
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│   Proverbs     │                    │   SearchResearch │
│   Weather      │                    │   MapsResearch   │
└─────────────────┘                    └─────────────────┘
```

## Next Steps

- Customize the agent logic in `agent/agent.py`
- Modify the UI in `src/app/page.tsx`
- Add new frontend actions and tools
- Deploy to production

## Resources

- [ADK Documentation](https://google.github.io/adk-docs/)
- [CopilotKit Documentation](https://docs.copilotkit.ai)
- [AG-UI Protocol](https://github.com/CopilotKit/ag-ui)
- [Original Tutorial](https://dev.to/copilotkit/build-a-frontend-for-your-adk-agents-with-ag-ui-2alo)
